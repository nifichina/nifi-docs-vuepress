<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>从jvm源码解读Java运行时的类加载（转） | NIFI中文文档</title>
    <meta name="description" content="NIFI中文文档">
    <link rel="icon" href="/logo.png">
    
    <link rel="preload" href="/assets/css/0.styles.362009db.css" as="style"><link rel="preload" href="/assets/js/app.005f1c60.js" as="script"><link rel="preload" href="/assets/js/56.423cbb25.js" as="script"><link rel="prefetch" href="/assets/js/10.3a80d037.js"><link rel="prefetch" href="/assets/js/11.26cb5acc.js"><link rel="prefetch" href="/assets/js/12.fa9f8d8d.js"><link rel="prefetch" href="/assets/js/13.8af67a59.js"><link rel="prefetch" href="/assets/js/14.5adb4a00.js"><link rel="prefetch" href="/assets/js/15.6d068ed3.js"><link rel="prefetch" href="/assets/js/16.61c4d397.js"><link rel="prefetch" href="/assets/js/17.0e3a8a98.js"><link rel="prefetch" href="/assets/js/18.9408ae5c.js"><link rel="prefetch" href="/assets/js/19.10814849.js"><link rel="prefetch" href="/assets/js/2.72e41f80.js"><link rel="prefetch" href="/assets/js/20.596fbf34.js"><link rel="prefetch" href="/assets/js/21.8c75b8a4.js"><link rel="prefetch" href="/assets/js/22.f7689c27.js"><link rel="prefetch" href="/assets/js/23.c1b66af7.js"><link rel="prefetch" href="/assets/js/24.d0b6a3d7.js"><link rel="prefetch" href="/assets/js/25.ae1ae68a.js"><link rel="prefetch" href="/assets/js/26.34e06b01.js"><link rel="prefetch" href="/assets/js/27.7c498dbc.js"><link rel="prefetch" href="/assets/js/28.c436f913.js"><link rel="prefetch" href="/assets/js/29.0d450748.js"><link rel="prefetch" href="/assets/js/3.e50e3499.js"><link rel="prefetch" href="/assets/js/30.1459513b.js"><link rel="prefetch" href="/assets/js/31.9a2f0f3e.js"><link rel="prefetch" href="/assets/js/32.cfceea92.js"><link rel="prefetch" href="/assets/js/33.f9d5ed21.js"><link rel="prefetch" href="/assets/js/34.a1f5aea6.js"><link rel="prefetch" href="/assets/js/35.400e42ab.js"><link rel="prefetch" href="/assets/js/36.cc28c160.js"><link rel="prefetch" href="/assets/js/37.b4548f0e.js"><link rel="prefetch" href="/assets/js/38.e0caa827.js"><link rel="prefetch" href="/assets/js/39.f0daa7eb.js"><link rel="prefetch" href="/assets/js/4.6947d476.js"><link rel="prefetch" href="/assets/js/40.fae19204.js"><link rel="prefetch" href="/assets/js/41.41f16ad8.js"><link rel="prefetch" href="/assets/js/42.c7dcfb07.js"><link rel="prefetch" href="/assets/js/43.38b58beb.js"><link rel="prefetch" href="/assets/js/44.398f4524.js"><link rel="prefetch" href="/assets/js/45.8879990e.js"><link rel="prefetch" href="/assets/js/46.58777ce7.js"><link rel="prefetch" href="/assets/js/47.0b4f24ad.js"><link rel="prefetch" href="/assets/js/48.9fab6bd1.js"><link rel="prefetch" href="/assets/js/49.e784ab6a.js"><link rel="prefetch" href="/assets/js/5.d0d2920a.js"><link rel="prefetch" href="/assets/js/50.4d4da836.js"><link rel="prefetch" href="/assets/js/51.42c04a42.js"><link rel="prefetch" href="/assets/js/52.cf8a87f1.js"><link rel="prefetch" href="/assets/js/53.94a0c7a1.js"><link rel="prefetch" href="/assets/js/54.6265453d.js"><link rel="prefetch" href="/assets/js/55.16fe73ba.js"><link rel="prefetch" href="/assets/js/57.d76cbe1e.js"><link rel="prefetch" href="/assets/js/58.7c0d9502.js"><link rel="prefetch" href="/assets/js/6.ee3e07cc.js"><link rel="prefetch" href="/assets/js/7.a4fce89a.js"><link rel="prefetch" href="/assets/js/8.a8194341.js"><link rel="prefetch" href="/assets/js/9.55b30490.js">
    <link rel="stylesheet" href="/assets/css/0.styles.362009db.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">NIFI中文文档</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/" class="sidebar-link">首頁</a></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>General</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Developer</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Processors</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Controller Services</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Reporting Tasks</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>NIFI 源码系列</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>NIFI 扩展开发系列</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>Java source code</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/java-source-code/ProcessBuilder.html" class="sidebar-link">ProcessBuilder</a></li><li><a href="/java-source-code/ClassLoader.html" class="sidebar-link">ClassLoader</a></li><li><a href="/java-source-code/Thread.html" class="sidebar-link">Thread</a></li><li><a href="/java-source-code/ContextClassLoader.html" class="sidebar-link">线程上下文类加载器</a></li><li><a href="/java-source-code/从jvm源码解读Java运行时的类加载.html" class="active sidebar-link">从jvm源码解读Java运行时的类加载</a></li><li><a href="/java-source-code/Socket.html" class="sidebar-link">Java socket详解（转）</a></li><li><a href="/java-source-code/HashMap.html" class="sidebar-link">Java HashMap 新增方法(merge,compute)（转）</a></li><li><a href="/" class="sidebar-link">待续</a></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Jetty source code</span> <span class="arrow right"></span></p> <!----></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="从jvm源码解读java运行时的类加载（转）"><a href="#从jvm源码解读java运行时的类加载（转）" aria-hidden="true" class="header-anchor">#</a> 从jvm源码解读Java运行时的类加载（转）</h1> <hr> <p>编辑人：<strong><strong>酷酷的诚</strong></strong>  邮箱：<strong>zhangchengk@foxmail.com</strong></p> <hr> <p>内容：</p> <p>对于Java项目在运行的时候是如何工作的，这个问题我一直比较模糊，虽然知道是那三种类加载机制（bootstrapClassLoader，extendsionClassLoader和systemAppClassLoader）,但具体是怎么实现的呢？</p> <p>Java在加载JVM的时候会先加载jdk的一些环境变量，例如jre的路径、jvm的路径等，这些过程都是由C语言实现的。代码位于hotspot\src\share\tools\launcher下面java.c</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span>  
<span class="token punctuation">{</span>  
    <span class="token keyword">char</span> <span class="token operator">*</span>jarfile <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
    <span class="token keyword">char</span> <span class="token operator">*</span>classname <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
    <span class="token keyword">char</span> <span class="token operator">*</span>s <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
    <span class="token keyword">char</span> <span class="token operator">*</span>main_class <span class="token operator">=</span> NULL<span class="token punctuation">;</span>  
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>  
    <span class="token class-name">InvocationFunctions</span> ifn<span class="token punctuation">;</span>  
    jlong start<span class="token punctuation">,</span> end<span class="token punctuation">;</span>  
    <span class="token keyword">char</span> jrepath<span class="token punctuation">[</span>MAXPATHLEN<span class="token punctuation">]</span><span class="token punctuation">,</span> jvmpath<span class="token punctuation">[</span>MAXPATHLEN<span class="token punctuation">]</span><span class="token punctuation">;</span>  
    <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span> original_argv <span class="token operator">=</span> argv<span class="token punctuation">;</span>  

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">&quot;_JAVA_LAUNCHER_DEBUG&quot;</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        _launcher_debug <span class="token operator">=</span> JNI_TRUE<span class="token punctuation">;</span>  
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;----_JAVA_LAUNCHER_DEBUG----\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
    <span class="token punctuation">{</span>  
      <span class="token keyword">int</span> i<span class="token punctuation">;</span>  
      original_argv <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token class-name">JLI_MemAlloc</span><span class="token punctuation">(</span><span class="token function">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>argc<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
      <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> argc<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>  
        original_argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  

    <span class="token class-name">CreateExecutionEnvironment</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>argc<span class="token punctuation">,</span> <span class="token operator">&amp;</span>argv<span class="token punctuation">,</span>  
                               jrepath<span class="token punctuation">,</span> <span class="token function">sizeof</span><span class="token punctuation">(</span>jrepath<span class="token punctuation">)</span><span class="token punctuation">,</span>  
                               jvmpath<span class="token punctuation">,</span> <span class="token function">sizeof</span><span class="token punctuation">(</span>jvmpath<span class="token punctuation">)</span><span class="token punctuation">,</span>  
                               original_argv<span class="token punctuation">)</span><span class="token punctuation">;</span>  

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Using java runtime at: %s\n&quot;</span><span class="token punctuation">,</span> jrepath<span class="token punctuation">)</span><span class="token punctuation">;</span>  

    ifn<span class="token punctuation">.</span><span class="token class-name">CreateJavaVM</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
    ifn<span class="token punctuation">.</span><span class="token class-name">GetDefaultJavaVMInitArgs</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  

    <span class="token keyword">if</span> <span class="token punctuation">(</span>_launcher_debug<span class="token punctuation">)</span>  
      start <span class="token operator">=</span> <span class="token class-name">CounterGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">LoadJavaVM</span><span class="token punctuation">(</span>jvmpath<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ifn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
      <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_launcher_debug<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
      end   <span class="token operator">=</span> <span class="token class-name">CounterGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%ld micro seconds to LoadJavaVM\n&quot;</span><span class="token punctuation">,</span>  
             <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>jint<span class="token punctuation">)</span><span class="token class-name">Counter2Micros</span><span class="token punctuation">(</span>end<span class="token operator">-</span>start<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
</code></pre></div><p>当加载完jvm后接下来会设置ClassPath，jvm的堆栈大小</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/*     \* If user doesn't specify stack size, check if VM has a preference.
     \* Note that HotSpot no longer supports JNI_VERSION_1_1 but it will
     \* return its default stack size through the init args structure.
     \*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>threadStackSize <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      struct <span class="token class-name">JDK1_1InitArgs</span> args1_1<span class="token punctuation">;</span>
      <span class="token function">memset</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>args1_1<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">sizeof</span><span class="token punctuation">(</span>args1_1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      args1_1<span class="token punctuation">.</span>version <span class="token operator">=</span> JNI_VERSION_1_1<span class="token punctuation">;</span>
      ifn<span class="token punctuation">.</span><span class="token class-name">GetDefaultJavaVMInitArgs</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>args1_1<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* ignore return value \*/</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>args1_1<span class="token punctuation">.</span>javaStackSize <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         threadStackSize <span class="token operator">=</span> args1_1<span class="token punctuation">.</span>javaStackSize<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>这些准备工作完成后，接下来就开始调用我们Java项目的main方法了（源码见java.c的JavaMain函数）</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">int</span> JNICALL
<span class="token class-name">JavaMain</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span> _args<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    struct <span class="token class-name">JavaMainArgs</span> <span class="token operator">*</span>args <span class="token operator">=</span> <span class="token punctuation">(</span>struct <span class="token class-name">JavaMainArgs</span> <span class="token operator">*</span><span class="token punctuation">)</span>_args<span class="token punctuation">;</span>
    <span class="token keyword">int</span> argc <span class="token operator">=</span> args<span class="token operator">-&gt;</span>argc<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv <span class="token operator">=</span> args<span class="token operator">-&gt;</span>argv<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>jarfile <span class="token operator">=</span> args<span class="token operator">-&gt;</span>jarfile<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>classname <span class="token operator">=</span> args<span class="token operator">-&gt;</span>classname<span class="token punctuation">;</span>
    <span class="token class-name">InvocationFunctions</span> ifn <span class="token operator">=</span> args<span class="token operator">-&gt;</span>ifn<span class="token punctuation">;</span>

    <span class="token class-name">JavaVM</span> <span class="token operator">*</span>vm <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">JNIEnv</span> <span class="token operator">*</span>env <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    jstring mainClassName<span class="token punctuation">;</span>
    jclass mainClass<span class="token punctuation">;</span>
    jmethodID mainID<span class="token punctuation">;</span>
    jobjectArray mainArgs<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    jlong start<span class="token punctuation">,</span> end<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>首先会初始化一大批参数，Java程序有两种方式一种是jar包，一种是class. 运行jar,Java -jar<br>
XXX.jar运行的时候，Java.exe调用GetMainClassName函数，该函数先获得JNIEnv实例然后调用Java类Java.util.jar.JarFileJNIEnv中方法getManifest()并从返回的Manifest对象中取getAttributes(&quot;Main-Class&quot;)的值即jar包中文件：META-INF/MANIFEST.MF指定的Main-Class的主类名作为运行的主类。之后main函数会调用Java.c中LoadClass方法装载该主类（使用JNIEnv实例的FindClass）。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/*     \* Get the application's main class.
     \*
     \* See bugid 5030265.  The Main-Class name has already been parsed
     \* from the manifest, but not parsed properly for UTF-8 support.
     \* Hence the code here ignores the value previously extracted and
     \* uses the pre-existing code to reextract the value.  This is
     \* possibly an end of release cycle expedient.  However, it has
     \* also been discovered that passing some character sets through
     \* the environment has &quot;strange&quot; behavior on some variants of
     \* Windows.  Hence, maybe the manifest parsing code local to the
     \* launcher should never be enhanced.
     \*
     \* Hence, future work should either:
     \*     1)   Correct the local parsing code and verify that the
     \*          Main-Class attribute gets properly passed through
     \*          all environments,
     \*     2)   Remove the vestages of maintaining main_class through
     \*          the environment (and remove these comments).
     \*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>jarfile <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mainClassName <span class="token operator">=</span> <span class="token class-name">GetMainClassName</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> jarfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token class-name">ExceptionOccurred</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ReportExceptionDescription</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> leave<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mainClassName <span class="token operator">==</span> NULL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> format <span class="token operator">=</span> <span class="token string">&quot;Failed to load Main-Class manifest &quot;</span>
                                <span class="token string">&quot;attribute from\n%s&quot;</span><span class="token punctuation">;</span>
          message <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token class-name">JLI_MemAlloc</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>format<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">strlen</span><span class="token punctuation">(</span>jarfile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span>
                                    <span class="token function">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">sprintf</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> format<span class="token punctuation">,</span> jarfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
          messageDest <span class="token operator">=</span> JNI_TRUE<span class="token punctuation">;</span>
          <span class="token keyword">goto</span> leave<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        classname <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token class-name">GetStringUTFChars</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> mainClassName<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>classname <span class="token operator">==</span> NULL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ReportExceptionDescription</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> leave<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mainClass <span class="token operator">=</span> <span class="token class-name">LoadClass</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> classname<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>mainClass <span class="token operator">==</span> NULL<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* exception occured \*/</span>
            <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> format <span class="token operator">=</span> <span class="token string">&quot;Could not find the main class: %s. Program will exit.&quot;</span><span class="token punctuation">;</span>
            <span class="token class-name">ReportExceptionDescription</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
            message <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token class-name">JLI_MemAlloc</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>format<span class="token punctuation">)</span> <span class="token operator">+</span>                                            <span class="token function">strlen</span><span class="token punctuation">(</span>classname<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            messageDest <span class="token operator">=</span> JNI_TRUE<span class="token punctuation">;</span>
            <span class="token function">sprintf</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> format<span class="token punctuation">,</span> classname<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> leave<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token class-name">ReleaseStringUTFChars</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> mainClassName<span class="token punctuation">,</span> classname<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      mainClassName <span class="token operator">=</span> <span class="token class-name">NewPlatformString</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> classname<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>mainClassName <span class="token operator">==</span> NULL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> format <span class="token operator">=</span> <span class="token string">&quot;Failed to load Main Class: %s&quot;</span><span class="token punctuation">;</span>
        message <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token class-name">JLI_MemAlloc</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>format<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">strlen</span><span class="token punctuation">(</span>classname<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span>
                                   <span class="token function">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sprintf</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> format<span class="token punctuation">,</span> classname<span class="token punctuation">)</span><span class="token punctuation">;</span>
        messageDest <span class="token operator">=</span> JNI_TRUE<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> leave<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      classname <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token class-name">GetStringUTFChars</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> mainClassName<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>classname <span class="token operator">==</span> NULL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ReportExceptionDescription</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> leave<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      mainClass <span class="token operator">=</span> <span class="token class-name">LoadClass</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> classname<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>mainClass <span class="token operator">==</span> NULL<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* exception occured \*/</span>
        <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> format <span class="token operator">=</span> <span class="token string">&quot;Could not find the main class: %s.  Program will exit.&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">ReportExceptionDescription</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
        message <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token class-name">JLI_MemAlloc</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>format<span class="token punctuation">)</span> <span class="token operator">+</span>                                        <span class="token function">strlen</span><span class="token punctuation">(</span>classname<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        messageDest <span class="token operator">=</span> JNI_TRUE<span class="token punctuation">;</span>
        <span class="token function">sprintf</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> format<span class="token punctuation">,</span> classname<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> leave<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token class-name">ReleaseStringUTFChars</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> mainClassName<span class="token punctuation">,</span> classname<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* Get the application's main method \*/</span>    mainID <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token class-name">GetStaticMethodID</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> mainClass<span class="token punctuation">,</span> <span class="token string">&quot;main&quot;</span><span class="token punctuation">,</span>
                                       <span class="token string">&quot;([Ljava/lang/String;)V&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mainID <span class="token operator">==</span> NULL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token class-name">ExceptionOccurred</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ReportExceptionDescription</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          message <span class="token operator">=</span> <span class="token string">&quot;No main method found in specified class.&quot;</span><span class="token punctuation">;</span>
          messageDest <span class="token operator">=</span> JNI_TRUE<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">goto</span> leave<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">{</span>    <span class="token comment">/* Make sure the main method is public \*/</span>        jint mods<span class="token punctuation">;</span>
        jmethodID mid<span class="token punctuation">;</span>
        jobject obj <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token class-name">ToReflectedMethod</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> mainClass<span class="token punctuation">,</span>
                                                mainID<span class="token punctuation">,</span> JNI_TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span> obj <span class="token operator">==</span> NULL<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* exception occurred \*/</span>            <span class="token class-name">ReportExceptionDescription</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> leave<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        mid <span class="token operator">=</span>          <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token class-name">GetMethodID</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>
                              <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token class-name">GetObjectClass</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">,</span>
                              <span class="token string">&quot;getModifiers&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;()I&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token class-name">ExceptionOccurred</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ReportExceptionDescription</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> leave<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        mods <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token class-name">CallIntMethod</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> obj<span class="token punctuation">,</span> mid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mods <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* if (!Modifier.isPublic(mods)) ... \*/</span>            message <span class="token operator">=</span> <span class="token string">&quot;Main method not public.&quot;</span><span class="token punctuation">;</span>
            messageDest <span class="token operator">=</span> JNI_TRUE<span class="token punctuation">;</span>
            <span class="token keyword">goto</span> leave<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>GetMainClassName()函数的实现过程如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">static</span> jstring
<span class="token class-name">GetMainClassName</span><span class="token punctuation">(</span><span class="token class-name">JNIEnv</span> <span class="token operator">*</span>env<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>jarname<span class="token punctuation">)</span>
<span class="token punctuation">{</span>\#define MAIN_CLASS <span class="token string">&quot;Main-Class&quot;</span>    jclass cls<span class="token punctuation">;</span>
    jmethodID mid<span class="token punctuation">;</span>
    jobject jar<span class="token punctuation">,</span> man<span class="token punctuation">,</span> attr<span class="token punctuation">;</span>
    jstring str<span class="token punctuation">,</span> result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token function">NULL_CHECK0</span><span class="token punctuation">(</span>cls <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token class-name">FindClass</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">&quot;java/util/jar/JarFile&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">NULL_CHECK0</span><span class="token punctuation">(</span>mid <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token class-name">GetMethodID</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> cls<span class="token punctuation">,</span> <span class="token string">&quot;&lt;init&gt;&quot;</span><span class="token punctuation">,</span>
                                          <span class="token string">&quot;(Ljava/lang/String;)V&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">NULL_CHECK0</span><span class="token punctuation">(</span>str <span class="token operator">=</span> <span class="token class-name">NewPlatformString</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> jarname<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">NULL_CHECK0</span><span class="token punctuation">(</span>jar <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token class-name">NewObject</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> cls<span class="token punctuation">,</span> mid<span class="token punctuation">,</span> str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">NULL_CHECK0</span><span class="token punctuation">(</span>mid <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token class-name">GetMethodID</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> cls<span class="token punctuation">,</span> <span class="token string">&quot;getManifest&quot;</span><span class="token punctuation">,</span>
                                          <span class="token string">&quot;()Ljava/util/jar/Manifest;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    man <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token class-name">CallObjectMethod</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> jar<span class="token punctuation">,</span> mid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>man <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">NULL_CHECK0</span><span class="token punctuation">(</span>mid <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token class-name">GetMethodID</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>
                                    <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token class-name">GetObjectClass</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> man<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                    <span class="token string">&quot;getMainAttributes&quot;</span><span class="token punctuation">,</span>
                                    <span class="token string">&quot;()Ljava/util/jar/Attributes;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        attr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token class-name">CallObjectMethod</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> man<span class="token punctuation">,</span> mid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>attr <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">NULL_CHECK0</span><span class="token punctuation">(</span>mid <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token class-name">GetMethodID</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>
                                    <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token class-name">GetObjectClass</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> attr<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                    <span class="token string">&quot;getValue&quot;</span><span class="token punctuation">,</span>
                                    <span class="token string">&quot;(Ljava/lang/String;)Ljava/lang/String;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">NULL_CHECK0</span><span class="token punctuation">(</span>str <span class="token operator">=</span> <span class="token class-name">NewPlatformString</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> MAIN_CLASS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token class-name">CallObjectMethod</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> attr<span class="token punctuation">,</span> mid<span class="token punctuation">,</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果是执行class方法。则先调用NewPlatformString(env, classname)获取mainClassName，然后直接调用LoadClass(env, classname)来加载该类。NewPlatformString()函数如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/* \* Returns a new Java string object for the specified platform string.
 \*/</span>
<span class="token keyword">static</span> jstring
<span class="token class-name">NewPlatformString</span><span class="token punctuation">(</span><span class="token class-name">JNIEnv</span> <span class="token operator">*</span>env<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>s<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">strlen</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    jclass cls<span class="token punctuation">;</span>
    jmethodID mid<span class="token punctuation">;</span>
    jbyteArray ary<span class="token punctuation">;</span>
    jstring enc<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> NULL<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    enc <span class="token operator">=</span> <span class="token function">getPlatformEncoding</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>

    ary <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token class-name">NewByteArray</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ary <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        jstring str <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token class-name">SetByteArrayRegion</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> ary<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">,</span> <span class="token punctuation">(</span>jbyte <span class="token operator">*</span><span class="token punctuation">)</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token class-name">ExceptionOccurred</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isEncodingSupported</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> enc<span class="token punctuation">)</span> <span class="token operator">==</span> JNI_TRUE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">NULL_CHECK0</span><span class="token punctuation">(</span>cls <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token class-name">FindClass</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">&quot;java/lang/String&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">NULL_CHECK0</span><span class="token punctuation">(</span>mid <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token class-name">GetMethodID</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> cls<span class="token punctuation">,</span> <span class="token string">&quot;&lt;init&gt;&quot;</span><span class="token punctuation">,</span>
                                          <span class="token string">&quot;([BLjava/lang/String;)V&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                str <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token class-name">NewObject</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> cls<span class="token punctuation">,</span> mid<span class="token punctuation">,</span> ary<span class="token punctuation">,</span> enc<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">/*If the encoding specified in sun.jnu.encoding is not
                  endorsed by &quot;Charset.isSupported&quot; we have to fall back
                  to use String(byte[]) explicitly here without specifying
                  the encoding name, in which the StringCoding class will
                  pickup the iso-8859-1 as the fallback converter for us.
                \*/</span>                <span class="token function">NULL_CHECK0</span><span class="token punctuation">(</span>cls <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token class-name">FindClass</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">&quot;java/lang/String&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">NULL_CHECK0</span><span class="token punctuation">(</span>mid <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token class-name">GetMethodID</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> cls<span class="token punctuation">,</span> <span class="token string">&quot;&lt;init&gt;&quot;</span><span class="token punctuation">,</span>
                                          <span class="token string">&quot;([B)V&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                str <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token class-name">NewObject</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> cls<span class="token punctuation">,</span> mid<span class="token punctuation">,</span> ary<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token class-name">DeleteLocalRef</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> ary<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> str<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>至于加载类方法，直接将类名的指针压入JVM的堆栈中，过程如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/* \* Loads a class, convert the '.' to '/'.
 \*/</span>
<span class="token keyword">static</span> jclass
<span class="token class-name">LoadClass</span><span class="token punctuation">(</span><span class="token class-name">JNIEnv</span> <span class="token operator">*</span>env<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>buf <span class="token operator">=</span> <span class="token class-name">JLI_MemAlloc</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>s <span class="token operator">=</span> buf<span class="token punctuation">,</span> <span class="token operator">*</span>t <span class="token operator">=</span> name<span class="token punctuation">,</span> c<span class="token punctuation">;</span>
    jclass cls<span class="token punctuation">;</span>
    jlong start<span class="token punctuation">,</span> end<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>_launcher_debug<span class="token punctuation">)</span>
        start <span class="token operator">=</span> <span class="token class-name">CounterGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        c <span class="token operator">=</span> <span class="token operator">*</span>t<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token operator">*</span>s<span class="token operator">++</span> <span class="token operator">=</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token string">'.'</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">'/'</span> <span class="token operator">:</span> c<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>c <span class="token operator">!=</span> <span class="token string">'\0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cls <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token class-name">FindClass</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">JLI_MemFree</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>_launcher_debug<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        end   <span class="token operator">=</span> <span class="token class-name">CounterGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%ld micro seconds to load main class\n&quot;</span><span class="token punctuation">,</span>
               <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>jint<span class="token punctuation">)</span><span class="token class-name">Counter2Micros</span><span class="token punctuation">(</span>end<span class="token operator">-</span>start<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;----_JAVA_LAUNCHER_DEBUG----\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> cls<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>之后就是JNI_ENTRY实例调用main方法了</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/* Invoke main method. \*/</span>    <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token class-name">CallStaticVoidMethod</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> mainClass<span class="token punctuation">,</span> mainID<span class="token punctuation">,</span> mainArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">CallStaticVoidMethod</span>是<span class="token class-name">C</span><span class="token operator">++</span>实现的，位于\hotspot\src\share\vm\prims下的jni<span class="token punctuation">.</span>cpp
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token function">JNI_ENTRY</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">,</span> <span class="token function">jni_CallStaticVoidMethod</span><span class="token punctuation">(</span><span class="token class-name">JNIEnv</span> <span class="token operator">*</span>env<span class="token punctuation">,</span> jclass cls<span class="token punctuation">,</span> jmethodID methodID<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token class-name">JNIWrapper</span><span class="token punctuation">(</span><span class="token string">&quot;CallStaticVoidMethod&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">DTRACE_PROBE3</span><span class="token punctuation">(</span>hotspot_jni<span class="token punctuation">,</span> <span class="token class-name">CallStaticVoidMethod__entry</span><span class="token punctuation">,</span> env<span class="token punctuation">,</span> cls<span class="token punctuation">,</span> methodID<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">DT_VOID_RETURN_MARK</span><span class="token punctuation">(</span><span class="token class-name">CallStaticVoidMethod</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  va_list args<span class="token punctuation">;</span>
  <span class="token function">va_start</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> methodID<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">JavaValue</span> <span class="token function">jvalue</span><span class="token punctuation">(</span>T_VOID<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">JNI_ArgumentPusherVaArg</span> <span class="token function">ap</span><span class="token punctuation">(</span>methodID<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">jni_invoke_static</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token operator">&amp;</span>jvalue<span class="token punctuation">,</span> NULL<span class="token punctuation">,</span> JNI_STATIC<span class="token punctuation">,</span> methodID<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ap<span class="token punctuation">,</span> CHECK<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">va_end</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
JNI_END
</code></pre></div><p>这样jvm就开始执行我们的java代码了。</p> <p>在hotspot\src\share\vm\prims\jvm.cpp中有大量的JVM_ENTRY实例的内部方法，例如从根加载器中获取类JVM_FindClassFromBootLoader</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// Returns a class loaded by the bootstrap class loader; or null// if not found.  ClassNotFoundException is not thrown.//// Rationale behind JVM_FindClassFromBootLoader// a&gt; JVM_FindClassFromClassLoader was never exported in the export tables.// b&gt; because of (a) java.dll has a direct dependecy on the  unexported//    private symbol &quot;_JVM_FindClassFromClassLoader@20&quot;.// c&gt; the launcher cannot use the private symbol as it dynamically opens//    the entry point, so if something changes, the launcher will fail//    unexpectedly at runtime, it is safest for the launcher to dlopen a//    stable exported interface.// d&gt; re-exporting JVM_FindClassFromClassLoader as public, will cause its//    signature to change from _JVM_FindClassFromClassLoader@20 to//    JVM_FindClassFromClassLoader and will not be backward compatible//    with older JDKs.// Thus a public/stable exported entry point is the right solution,// public here means public in linker semantics, and is exported only// to the JDK, and is not intended to be a public API.</span>
<span class="token function">JVM_ENTRY</span><span class="token punctuation">(</span>jclass<span class="token punctuation">,</span> <span class="token class-name">JVM_FindClassFromBootLoader</span><span class="token punctuation">(</span><span class="token class-name">JNIEnv</span><span class="token operator">*</span> env<span class="token punctuation">,</span>
                                              <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token class-name">JVMWrapper2</span><span class="token punctuation">(</span><span class="token string">&quot;JVM_FindClassFromBootLoader %s&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Java libraries should ensure that name is never null...</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">==</span> NULL <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">strlen</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token class-name">Symbol</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">max_length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// It's impossible to create this class;  the name cannot fit</span>
    <span class="token comment">// into the constant pool.</span>
    <span class="token keyword">return</span> NULL<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">TempNewSymbol</span> h_name <span class="token operator">=</span> <span class="token class-name">SymbolTable</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">new_symbol</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> CHECK_NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>
  klassOop k <span class="token operator">=</span> <span class="token class-name">SystemDictionary</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">resolve_or_null</span><span class="token punctuation">(</span>h_name<span class="token punctuation">,</span> CHECK_NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">==</span> NULL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> NULL<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">TraceClassResolution</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">trace_class_resolution</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>jclass<span class="token punctuation">)</span> <span class="token class-name">JNIHandles</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">make_local</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token class-name">Klass</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">cast</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">java_mirror</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
JVM_END
</code></pre></div><p>关于ClassLoader这个类，位于\jdk\src\share\classes\java\lang下面，这是一个抽象类；而在\jdk\src\share\classes\java\security\下面有一个类SecureClassLoader继承ClassLoader；另外在\jdk\src\share\classes\java\net\下面有一个类URLClassLoader继承SecureClassLoader；这里来看一下sun对这三个类的功能描述：</p> <p>URLClassLoader：This class loader is used to load classes and resources from a search path of URLs referring to both JAR files and directories. Any URL that ends with a '/' is assumed to refer to a directory. Otherwise, the URL is assumed to refer to a JAR file which will be opened as needed.</p> <p>大致意思是：这个类加载器是用于从一个引用JAR包和目录的URL搜索路径加载类和资源的。对于任何以'/'结尾的URL都被认为是一个目录。否则这个URL被认为是一个根据需要打开的jar包。</p> <p>也就是说URLClassLoader这个类用来加载jar包和我们项目中自己实现的类，Extension ClassLoader 和 App ClassLoader都是java.net.URLClassLoader的子类。</p> <p>SecureClassLoader：This class extends ClassLoader with additional support for defining classes with an associated code source and permissions which are retrieved by the system policy by default.</p> <p>大致意思是：这个类定义与相关的源代码和权限是由默认情况下，系统策略检索类的其他支持扩展类加载器。</p> <p>ClassLoader：A class loader is an object that is responsible for loading classes. The class <tt>ClassLoader</tt> is an abstract class.  Given the <a href="#name">binary name</a> of a class, a class loader should attempt to locate or generate data that constitutes a definition for the class.  A typical strategy is to transform the name into a file name and then read a &quot;class file&quot; of that name from a file system.</p> <p>ClassLoader是一个负责加载类的对象，他是一个抽象类。需要给出类的二进制名称，class loader尝试定位或者产生一个class的数据，一个典型的策略是把二进制名字转换成文件名然后到文件系统中找到该文件。</p> <p>这是它的构造器</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">(</span><span class="token class-name">Void</span> unused<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> parent<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ParallelLoaders</span><span class="token punctuation">.</span><span class="token function">isRegistered</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            parallelLockMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            package2certs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            domains <span class="token operator">=</span>                <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">synchronizedSet</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProtectionDomain</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            assertionLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// no finer-grained lock; lock on the classloader instance</span>
            parallelLockMap <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            package2certs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hashtable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            domains <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            assertionLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>根据ParallelLoaders.isRegistered的状态给parallelLockMap、package2certs、domains和assertionLock赋值。</p> <p>对于关键的加载类方法loadClass()</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">boolean</span> resolve<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token function">getClassLoadingLock</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// First, check if the class has already been loaded</span>
            <span class="token class-name">Class</span> c <span class="token operator">=</span> <span class="token function">findLoadedClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">long</span> t0 <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        c <span class="token operator">=</span> parent<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        c <span class="token operator">=</span> <span class="token function">findBootstrapClassOrNull</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// ClassNotFoundException thrown if class not found</span>
                    <span class="token comment">// from the non-null parent class loader</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// If still not found, then invoke findClass in order</span>
                    <span class="token comment">// to find the class.</span>
                    <span class="token keyword">long</span> t1 <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    c <span class="token operator">=</span> <span class="token function">findClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// this is the defining class loader; record the stats</span>
                    sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span><span class="token class-name">PerfCounter</span><span class="token punctuation">.</span><span class="token function">getParentDelegationTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addTime</span><span class="token punctuation">(</span>t1 <span class="token operator">-</span> t0<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span><span class="token class-name">PerfCounter</span><span class="token punctuation">.</span><span class="token function">getFindClassTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addElapsedTimeFrom</span><span class="token punctuation">(</span>t1<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span><span class="token class-name">PerfCounter</span><span class="token punctuation">.</span><span class="token function">getFindClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">resolveClass</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> c<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>先判断父加载器是否为空，如果存在父加载器，则让父加载器去加载类，传入resolve为false，表示未找到类；如果不存在父加载器，则表明已经是父加载器了也就是bootstrapClassLoader，直接调用上面说到的findBootstrapClassOrNull()来加载类，这里由于findBootstrapClassOrNull调用的方法是之前jvm初始化的时候C++实现的方法，这里如果调用它会返回null，所以如果c为null则调用之前jvm中的findClass方法来获取类，然后记录状态。最后如果成功找到该类，则返回resolve为true，调用resolveClass。</p></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">10/10/2019, 7:36:02 PM</span></div></div> <!----> </div> <div class="page"><section class="page-edit"><div><span data-flag-title="Your Article Title" class="leancloud-visitors"><em class="post-meta-item-text">阅读量： </em> <i class="leancloud-visitors-count"></i></span></div> <h3><a href="javascript:;"></a>
      评 论：
    </h3> <div id="vcomments"></div></section></div> <!----></div></div>
    <script src="/assets/js/app.005f1c60.js" defer></script><script src="/assets/js/56.423cbb25.js" defer></script>
  </body>
</html>
